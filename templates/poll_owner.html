{% extends "base.html" %}
{% block content %}
{% set active_page = "owner" %}
{% include "poll_navi.html" %}
<script type="text/javascript" src="/static/poll_owner.js"></script>


<h1>Kyselyn tiedot</h1>
<div class="section">
<ul>
    <li>Kuvaus: {{ poll.description }}</li>
    <li>Ensimmäinen varauspäivä: {{ poll.first_appointment_date }}</li>
    <li>Viimeinen varauspäivä: {{ poll.last_appointment_date }}</li>
    <li>Kysely päättyy: {{ poll.end_time }}</li>
</ul>
</div>

<div class="poll_owner">
{% if customers|length > 0 %}
<h1>Asiakkaat</h1>
<div class="section">
<table>
    <tr><th>Asiakkaan nimi</th><th>id</th><th>Varauksen kesto</th>
{% for customer in customers %}
<tr>
    <td>{{ customer[2] }}</td>
    <td>{{ customer[0] }}</td>
    <td>{{ customer[1] }}</td>
    <td>
    <a href="/poll/{{ poll.id }}/{{ customer[0] }}/times">
    Muokkaa
    </a>
    </td>
    <td>
    <form action="/delete_member" method="POST">
        <input type="submit" value="Poista">
        <input type="hidden" name="poll_id" value={{ poll.id }}>
        <input type="hidden" name="member_id" value={{ customer[0] }}>
        <input type="hidden" name="csrf_token" value= {{ session.get('csrf_token') }}>
    </form>
    </td>
    <td>
    <form action="/new_member_access_link" method="post">
    <input type="submit" value="Luo muokkauslinkki">
    <input type="hidden" name="member_id" id={{ customer[0] }}
           value={{ customer[0] }}>
    <input type="hidden" name="poll_id" value={{ poll.id }}>
    <input type="hidden" name="csrf_token" value={{ session.get('csrf_token') }}>
    </form>
    </td>
</tr>
{% endfor %}
</table>
</div>
{% endif %}


<h2>Luo uusi asiakas</h2>
<div class="section">
<form class="add_customer_form" action="/add_customer" method="POST">
    <ul>
    <li>
    <label for="customer_name">
        Asiakkan nimi
    </label>
    <input type="text" id="customer_name" name="customer_name">
    </li>
    <li>
    <label for="reservation_length">Varauksen kesto:</label>
    <input type="number" id="reservation_length"
           name="reservation_length" min=5 value=60 step=5>
    </li>
    <br>
    <li>
    <input type="submit" value="Luo asiakas">
    </li>
    <input type="hidden" name="poll_id" value={{ poll.id}}>
    <input type="hidden" name="csrf_token" value={{ session.get('csrf_token') }}>
    </ul>
</form>
</div>


<h2>Asiakkaanmuokkauslinkit</h2>
<div class="section">
<p>Nämä linkit antavat käyttäjälle oikeuden muokata tietyn asiakkaan aikatoiveita</p>
<table>
<tr><th>Asiakkaan nimi</th><th>id</th><th>Url</th></tr>
{% for link in customer_access_links %}
<tr>
    <td>{{ link[1] }}</td>
    <td>{{ link[2] }}</td>
    <td>
    <input type='text' size=30 id={{ link[0] }}
           value={{ url_for('access', url_id=link[0], _external=True) }}
           readonly>
    </td>
    <td><button class="copy_button" id={{ link[0] }}>Kopioi linkki</button></td>
    <td>
    <form action="/delete_member_access_link" method="POST">
        <input type="submit" value="Poista">
        <input type="hidden" name="url_id" value={{ link[0] }}>
        <input type="hidden" name="poll_id" value={{ poll.id }}>
        <input type="hidden" name="csrf_token" value={{ session.get('csrf_token') }}>
    </form>
    </td>
</tr>
{% endfor %}
<br>
</table>
</div>


<h2>Asiakkaanluontilinkit:</h2>
<div class="section">
<p>Nämä antavat käyttäjälle oikeuden luoda kyselyyn uusia asiakkaita
haluamallaan varauksen kestolla</p>
<table>
<tr><th>Url</th></tr>
{% for link in new_customer_links %}
<tr>
    <td>
    <input type='text' size=30 id={{ link[0] }} 
           value={{ url_for('new_customer', url_id=link[0], _external=True) }}
           readonly>
    </td>
    <td><button class="copy_button" id={{ link[0] }}>Kopioi linkki</button></td>
    <td>
    <form action="/delete_new_customer_link" method="POST">
        <input type="submit" value="Poista">
        <input type="hidden" name="url_id" value={{ link[0] }}>
        <input type="hidden" name="poll_id" value={{ poll.id }}>
        <input type="hidden" name="csrf_token" value={{ session.get('csrf_token') }}>
    </form>
    </td>
</tr>
{% endfor %}
</table>
</div>

<h2>Luo uusi asiakkaanluontilinkki</h2>
<div class="section">
<form action="/new_new_customer_link" method="post">
    <input type="submit" value="Luo linkki">
    <input type="hidden" name="poll_id" value={{ poll.id }}>
    <input type="hidden" name="csrf_token" value={{ session.get('csrf_token') }}>
</form>
</div>
<hr>
<h1>Resurssit</h1>
<div class="section">
<table>
<tr>
    <th>Resurssin id</th><th>Resurssin nimi</th>
<tr>
{% for resource in resources %}
<tr>
    <td>{{ resource[1] }}</td>
    <td>{{ resource[0] }}</td>
    <td>
    <a href="/poll/{{ poll.id }}/{{ resource[1] }}/times">
    Muokkaa
    </a>
    <td>
    <form action="/delete_member" method="POST">
        <input type="submit" value="Poista">
        <input type="hidden" name="poll_id" value={{ poll.id }}>
        <input type="hidden" name="member_id" value={{ resource[1] }}>
        <input type="hidden" name="csrf_token" value={{ session.get('csrf_token') }}>
    </form>
    </td>
    <td>
    <form action="/new_member_access_link" method="post">
    <input type="submit" value="Luo muokkauslinkki">
    <input type="hidden" name="member_id" id={{ resource[1] }}
           value={{ resource[1] }}>
    <input type="hidden" name="poll_id" value={{ poll.id }}>
    <input type="hidden" name="csrf_token" value={{ session.get('csrf_token') }}>
    </form>
    </td>

</tr>
{% endfor %}
</table>
</div>


<h2>Luo uusi resurssi:</h2>
<div class="section">
<form action="/new_resource" method="post">
<ul>
    <li>
    <label for="resource_name">Resurssin nimi:</label>
    <input type="text" name="resource_name" id="resource_name">
    </li>
    <li>
    <input type="submit" value="Luo resurssi">
    </li>
    <input type="hidden" name="poll_id" value={{ poll.id }}>
    <input type="hidden" name="csrf_token" value={{ session.get('csrf_token') }}>
</ul>
</form>
</div>


<h2>Resurssinmuokkauslinkit</h2>
<div class="section">
<p>Nämä linkit antavat käyttäjälle oikeuden muokata tietyn resurssin aikoja</p>
<table>
    <tr><th>Resurssin nimi</th><th>id</th><th>Url</th></tr>
{% for link in resource_access_links %}
<tr>
    <td>{{ link[1] }}</td>
    <td>{{ link[2] }}</td>
    <td>
    <input type='text' size=30 id={{ link[0] }} 
           value={{ url_for('new_customer', url_id=link[0], _external=True) }}
           readonly>
    </td>
    <td><button class="copy_button" id={{ link[0] }}>Kopioi linkki</button></td>
    <td>
    <form action="/delete_member_access_link" method="POST">
        <input type="submit" value="Poista">
        <input type="hidden" name="url_id" value={{ link[0] }}>
        <input type="hidden" name="poll_id" value={{ poll.id }}>
        <input type="hidden" name="csrf_token" value={{ session.get('csrf_token') }}>
    </form>
    </td>
</tr>
{% endfor %}
</table>
</div>



<hr>
<h1>Optimointi</h1>
<div class="section">
<form action="/optimize_poll" method="post">
    <input type="submit" value="Optimoi ajanvaraukset">
    <input type="hidden" name="poll_id" value={{ poll.id }}>
    <input type="hidden" name="csrf_token" value={{ session.get('csrf_token') }}>
</form>
</div>
<h2>Optimoinnin tulokset:</h2>
<div class="section">
{% if optimization_results|length > 0 %}
<table>
    <tr><th>Asiakkaan nimi</th>
        <th>Asiakkaan id</th>
        <th>Resurssin nimi</th>
        <th>Resurssin id</th>
        <th>Varauksen alkuaika</th>
    </tr>
{% for result in optimization_results %}
    <tr>
        <td>{{ result.customer_member_name }}</td>
        <td>{{ result.customer_member_id }}</td>
        <td>{{ result.resource_member_name }}</td>
        <td>{{ result.resource_member_id }}</td>
        <td>{{ result.time }}</td>
    </tr>
{% endfor %}
</table>
{% else %}
<p>Ei tuloksia tai optimointia ei ole suoritettu</p>
{% endif %}
</div>
</div>
{% endblock %}
